<div class="character-sheet-container" *ngIf="character">
  <!-- Header -->
  <div class="sheet-header">
    <div class="header-left">
      <h1>{{ character.name || 'Unnamed Character' }}</h1>
      <div class="header-subtitle">
        <span>Level {{ character.level }}</span>
        <span class="separator">•</span>
        <span>{{ character.ancestry || 'Unknown' }}</span>
        <span class="separator" *ngIf="character.paths.length > 0">•</span>
        <span *ngFor="let path of character.paths; let last = last">
          {{ path }}<span *ngIf="!last">, </span>
        </span>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button (click)="saveCharacter()">
        <mat-icon>save</mat-icon>
        Save
      </button>
      <button mat-button (click)="exportCharacter()">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <button mat-button (click)="backToList()">
        <mat-icon>list</mat-icon>
        Character List
      </button>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Spren Grant Notification -->
  <mat-card class="spren-notification" *ngIf="pendingSprenGrant">
    <mat-card-header>
      <mat-icon class="spren-icon">auto_awesome</mat-icon>
      <mat-card-title>A Spren Approaches!</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="spren-message">
        A <strong>{{ pendingSprenGrant.sprenType }}</strong> has offered to bond with you, 
        granting you the powers of a <strong>{{ pendingSprenGrant.order }}</strong>.
      </p>
      <p class="philosophy-text">
        <em>"{{ pendingSprenGrant.philosophy }}"</em>
      </p>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="acceptSpren()">
        <mat-icon>check_circle</mat-icon>
        Accept Bond
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Speak First Ideal -->
  <mat-card class="ideal-prompt" *ngIf="character && character.radiantPath.hasSpren() && !character.radiantPath.hasSpokenIdeal()">
    <mat-card-header>
      <mat-icon class="ideal-icon">record_voice_over</mat-icon>
      <mat-card-title>Speak the First Ideal</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="ideal-message">
        You have bonded with a spren. To unlock your surges, you must speak the First Ideal of the Knights Radiant:
      </p>
      <p class="first-ideal">
        <strong>"Life before death. Strength before weakness. Journey before destination."</strong>
      </p>
      <p class="order-info" *ngIf="character.radiantPath.getOrderInfo()">
        As a <strong>{{ character.radiantPath.getOrderInfo()?.order }}</strong>, 
        you will gain access to the surges of 
        <strong>{{ getSurgeNames() }}</strong>.
      </p>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="accent" (click)="speakIdeal()">
        <mat-icon>bolt</mat-icon>
        Speak the Words
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Main Content -->
  <div class="sheet-content">
    <!-- Left Column: Portrait, Talents & Notes -->
    <div class="left-column">
      <!-- Portrait Card -->
      <mat-card class="portrait-card">
        <div class="portrait-header">
          <h3 class="character-name-overlay">{{ character.name || 'Character' }}</h3>
        </div>
        <div class="portrait-image-container">
          <app-character-image
            [imageUrl]="portraitUrl"
            [characterName]="character.name || 'Character'"
            [size]="'large'"
            [showPlaceholder]="true">
          </app-character-image>
        </div>
        <div class="portrait-actions">
          <button mat-button (click)="openPortraitUpload()">
            <mat-icon>{{ getPortraitUrl() ? 'edit' : 'add_photo_alternate' }}</mat-icon>
            {{ getPortraitUrl() ? 'Change Portrait' : 'Add Portrait' }}
          </button>
        </div>
      </mat-card>

      <!-- Powers Card -->
      <mat-card class="powers-card">
        <mat-card-header>
          <mat-icon class="section-icon">auto_awesome</mat-icon>
          <mat-card-title>Powers</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="powers-list">
            <mat-accordion class="powers-accordion" *ngIf="getPowers().length > 0">
              <mat-expansion-panel *ngFor="let power of getPowers()" class="power-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title class="power-title">
                    <mat-icon class="power-icon">flash_on</mat-icon>
                    <span class="power-name">{{ power.name }}</span>
                  </mat-panel-title>
                  <mat-panel-description class="power-cost">
                    {{ getActionCostDisplay(power.actionCost) }}
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <div class="power-details">
                  <div class="power-description">
                    <p>{{ power.description }}</p>
                    <p *ngIf="power.specialActivation" class="special-activation">
                      <strong>Special Activation:</strong> {{ power.specialActivation }}
                    </p>
                  </div>
                  
                  <div class="power-bonuses" *ngIf="getBonusDisplay(power).length > 0">
                    <h4><mat-icon>trending_up</mat-icon> Bonuses</h4>
                    <ul>
                      <li *ngFor="let bonus of getBonusDisplay(power)">{{ bonus }}</li>
                    </ul>
                  </div>
                  
                  <div class="power-effects" *ngIf="getOtherEffects(power).length > 0">
                    <h4><mat-icon>auto_fix_high</mat-icon> Additional Effects</h4>
                    <ul>
                      <li *ngFor="let effect of getOtherEffects(power)">{{ effect }}</li>
                    </ul>
                  </div>
                  
                  <div class="power-meta">
                    <span class="power-tier">Tier {{ power.tier }}</span>
                    <span class="power-path" *ngIf="power.pathRequirement">
                      <mat-icon>route</mat-icon> {{ power.pathRequirement }}
                    </span>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
            
            <p class="empty-text" *ngIf="getPowers().length === 0">
              No powers unlocked yet
            </p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Session Notes Card -->
      <mat-card class="notes-card">
        <mat-card-header>
          <mat-icon class="section-icon">notes</mat-icon>
          <mat-card-title>Session Notes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="notes-field">
            <mat-label>Notes, objectives, and reminders...</mat-label>
            <textarea 
              matInput 
              [(ngModel)]="sessionNotes"
              (blur)="saveCharacter()"
              rows="10"
              placeholder="Track your adventure here...">
            </textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Middle Column: Resources -->
    <div class="middle-column">
      <app-resource-tracker 
        [resource]="healthResource"
        (valueChanged)="onResourceChanged('Health', $event)">
      </app-resource-tracker>

      <app-resource-tracker 
        [resource]="focusResource"
        (valueChanged)="onResourceChanged('Focus', $event)">
      </app-resource-tracker>

      <app-resource-tracker 
        [resource]="investitureResource"
        (valueChanged)="onResourceChanged('Investiture', $event)">
      </app-resource-tracker>
    </div>

    <!-- Right Column: Attributes, Defenses & Skills -->
    <div class="right-column">
      <!-- Attributes Card -->
      <mat-card class="stats-card">
        <mat-card-header>
          <mat-icon class="section-icon">fitness_center</mat-icon>
          <mat-card-title>Attributes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="attributes-grid">
            <div class="attribute-box">
              <span class="attr-label">Strength</span>
              <span class="attr-value">{{ character.attributes.strength }}</span>
            </div>
            <div class="attribute-box">
              <span class="attr-label">Speed</span>
              <span class="attr-value">{{ character.attributes.speed }}</span>
            </div>
            <div class="attribute-box">
              <span class="attr-label">Intellect</span>
              <span class="attr-value">{{ character.attributes.intellect }}</span>
            </div>
            <div class="attribute-box">
              <span class="attr-label">Willpower</span>
              <span class="attr-value">{{ character.attributes.willpower }}</span>
            </div>
            <div class="attribute-box">
              <span class="attr-label">Awareness</span>
              <span class="attr-value">{{ character.attributes.awareness }}</span>
            </div>
            <div class="attribute-box">
              <span class="attr-label">Presence</span>
              <span class="attr-value">{{ character.attributes.presence }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Defenses Card -->
      <mat-card class="stats-card">
        <mat-card-header>
          <mat-icon class="section-icon">shield</mat-icon>
          <mat-card-title>Defenses</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="defenses-list">
            <div class="defense-item">
              <span class="defense-label">Physical Defense</span>
              <span class="defense-value">{{ character.defenses.getPhysicalDefense(character.attributes, 0) }}</span>
            </div>
            <div class="defense-item">
              <span class="defense-label">Cognitive Defense</span>
              <span class="defense-value">{{ character.defenses.getCognitiveDefense(character.attributes, 0) }}</span>
            </div>
            <div class="defense-item">
              <span class="defense-label">Spiritual Defense</span>
              <span class="defense-value">{{ character.defenses.getSpiritualDefense(character.attributes, 0) }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Skills Card -->
      <mat-card class="stats-card">
        <mat-card-header>
          <mat-icon class="section-icon">school</mat-icon>
          <mat-card-title>Skills</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="skills-list">
            <div class="skill-item" *ngFor="let skill of getTrainedSkills()">
              <span class="skill-name">{{ skill.name }}</span>
              <span class="skill-ranks">Rank {{ skill.rank }}</span>
              <span class="skill-total">Total: +{{ skill.total }}</span>
            </div>
            <p class="empty-text" *ngIf="getTrainedSkills().length === 0">
              No skills trained
            </p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<div class="no-character" *ngIf="!character">
  <mat-icon>error_outline</mat-icon>
  <h2>No Character Loaded</h2>
  <p>Please select a character from the character list.</p>
  <button mat-raised-button color="primary" (click)="backToList()">
    Go to Character List
  </button>
</div>
