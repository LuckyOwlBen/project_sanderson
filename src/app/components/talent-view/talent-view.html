<div class="talent-view-container">
  <div class="talent-header">
    <h2>Talent Selection</h2>
    <div class="talent-points">
      <mat-icon>stars</mat-icon>
      <span>Available Points: {{ availableTalentPoints }}</span>
    </div>
  </div>

  <div class="validation-message" *ngIf="validationMessage">
    <mat-icon>info</mat-icon>
    <span>{{ validationMessage }}</span>
  </div>

  <!-- Spren Grant Notification -->
  <mat-card class="spren-notification" *ngIf="pendingSprenGrant">
    <mat-card-header>
      <mat-icon class="spren-icon">auto_awesome</mat-icon>
      <mat-card-title>A Spren Approaches!</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="spren-message">
        A <strong>{{ pendingSprenGrant.sprenType }}</strong> has offered to bond with you, 
        granting you the powers of a <strong>{{ pendingSprenGrant.order }}</strong>.
      </p>
      <p class="philosophy-text">
        <em>"{{ pendingSprenGrant.philosophy }}"</em>
      </p>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="acceptSpren()">
        <mat-icon>check_circle</mat-icon>
        Accept Bond
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Speak First Ideal -->
  <mat-card class="ideal-prompt" *ngIf="character && character.radiantPath.hasSpren() && !character.radiantPath.hasSpokenIdeal()">
    <mat-card-header>
      <mat-icon class="ideal-icon">record_voice_over</mat-icon>
      <mat-card-title>Speak the First Ideal</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="ideal-message">
        You have bonded with a spren. To unlock your surges, you must speak the First Ideal of the Knights Radiant:
      </p>
      <p class="first-ideal">
        <strong>"Life before death. Strength before weakness. Journey before destination."</strong>
      </p>
      <p class="order-info" *ngIf="character.radiantPath.getOrderInfo()">
        As a <strong>{{ character.radiantPath.getOrderInfo()?.order }}</strong>, 
        you will gain access to the surges of 
        <strong>{{ getSurgeNames() }}</strong>.
      </p>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="accent" (click)="speakIdeal()">
        <mat-icon>bolt</mat-icon>
        Speak the Words
      </button>
    </mat-card-actions>
  </mat-card>

  <div class="tree-selector" *ngIf="availableTrees.length > 1">
    <mat-chip-set>
      <mat-chip 
        *ngFor="let tree of availableTrees"
        [highlighted]="selectedTree?.pathName === tree.pathName"
        (click)="selectTree(tree)">
        {{ tree.pathName }}
      </mat-chip>
    </mat-chip-set>
  </div>

  <div class="talent-tree-container" *ngIf="selectedTree">
    <mat-card class="tree-info">
      <mat-card-header>
        <mat-card-title>{{ selectedTree.pathName }}</mat-card-title>
      </mat-card-header>
    </mat-card>

    <div class="talent-grid">
      <mat-card 
        *ngFor="let talent of getVisibleTalents()"
        class="talent-node"
        [class.unlocked]="isTalentUnlocked(talent.id)"
        [class.available]="canUnlockTalent(talent)"
        [class.locked]="!canUnlockTalent(talent) && !isTalentUnlocked(talent.id)"
        [ngStyle]="getTalentStyle(talent)">
        
        <mat-card-header>
          <mat-card-title>{{ talent.name }}</mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <p>{{ talent.description }}</p>
          
          <div class="prerequisites" *ngIf="talent.prerequisites.length > 0">
            <span class="prereq-label">Requires:</span>
            <ul>
              <li *ngFor="let prereq of talent.prerequisites">
                {{ formatPrerequisite(prereq) }}
              </li>
            </ul>
          </div>
        </mat-card-content>
        
        <mat-card-actions>
          <button 
            mat-raised-button 
            color="primary"
            *ngIf="!isTalentUnlocked(talent.id) && canUnlockTalent(talent)"
            (click)="unlockTalent(talent); $event.stopPropagation()">
            <mat-icon>add_circle</mat-icon>
            Select Talent
          </button>
          <button 
            mat-button
            *ngIf="!isTalentUnlocked(talent.id) && !canUnlockTalent(talent) && availableTalentPoints > 0"
            disabled>
            <mat-icon>lock</mat-icon>
            Prerequisites Not Met
          </button>
          <button 
            mat-button
            *ngIf="!isTalentUnlocked(talent.id) && !canUnlockTalent(talent) && availableTalentPoints <= 0"
            disabled>
            <mat-icon>stars</mat-icon>
            No Points Available
          </button>
          <button 
            mat-raised-button 
            color="warn"
            *ngIf="isTalentUnlocked(talent.id)"
            (click)="removeTalent(talent.id); $event.stopPropagation()">
            <mat-icon>remove_circle</mat-icon>
            Remove
          </button>
          <mat-icon *ngIf="isTalentUnlocked(talent.id)" class="unlocked-badge">check_circle</mat-icon>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <!-- Core Path Selector for bonus talent -->
  <div class="core-path-selector" *ngIf="showCorePathSelector && availableCorePaths.length > 0">
    <h3>Select a Bonus Path (Optional)</h3>
    <p class="helper-text">You can select a key talent from another heroic path as your bonus talent. This will unlock that path's specialties.</p>
    <div class="core-path-grid">
      <mat-card 
        *ngFor="let pathOption of availableCorePaths"
        class="core-path-card"
        [class.selected]="pathOption.isSelected"
        (click)="selectCorePath(pathOption)">
        <mat-card-header>
          <mat-card-title>{{ pathOption.name }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="key-talent-info">
            <strong>{{ pathOption.keyTalent.name }}</strong>
            <p>{{ pathOption.keyTalent.description }}</p>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button [color]="pathOption.isSelected ? 'warn' : 'primary'">
            <mat-icon>{{ pathOption.isSelected ? 'remove_circle' : 'add_circle' }}</mat-icon>
            {{ pathOption.isSelected ? 'Remove' : 'Select' }}
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <div class="no-trees" *ngIf="availableTrees.length === 0">
    <p>No talent trees available. Please select a path or ancestry first.</p>
  </div>
</div>